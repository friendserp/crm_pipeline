import{f as fe}from"./DeleteLinkedDocModal-7d7a9520.js";import{_ as _e}from"./ErrorPage-4fed20db.js";import{_ as ge}from"./Icon-63a07a4a.js";import{_ as ye}from"./Resizer-fe47508d.js";import{A as be,a as te,u as he,_ as Ce,b as ke,c as we,S as xe}from"./useActiveTabManager-abc075fc.js";import{E as Me}from"./Email2Icon-c54fab37.js";import{C as Ie}from"./CommentIcon-832423da.js";import{D as Ve}from"./DetailsIcon-fd72dd58.js";import{P as Le}from"./PhoneIcon-522161ac.js";import{T as Ee}from"./TaskIcon-78755536.js";import{N as Re}from"./NoteModal-f45ae9e1.js";import{W as De}from"./WhatsAppIcon-7bd50cb6.js";import{u as Z,c as Te,q as $e,I as Se,_ as Ae}from"./modals-e50c2257.js";import{C as ze}from"./CameraIcon-c67166f8.js";import{L as qe}from"./LinkIcon-04519bc7.js";import{L as Ue}from"./LayoutHeader-2ba5f317.js";import{g as Fe,S as Oe}from"./view-82f86313.js";import{_ as oe}from"./CustomActions-b50c5d5e.js";import{O as Pe}from"./OrganizationsIcon-38c2aaa4.js";import{C as Ne}from"./ContactsIcon-5b4c5190.js";import{E as je}from"./EditIcon-00e6e25e.js";import{F as Be}from"./FieldLayout-d6697801.js";import{L as le}from"./Link-c567bd91.js";import{u as We,a as se,d as Qe,s as Xe,D as ne,h as Ge,e as He,b as Je,o as Ke}from"./UserAvatar-0be15b99.js";import{J as Ye,K as Ze,a5 as ue,aR as ea,r as w,j as z,X as de,U as B,l as u,C as c,D as v,M as r,N as L,L as t,q as p,I as n,m as q,W as aa,aT as ee,aX as ta,aU as oa,k as ie,aW as la,aL as re,F as sa,aV as T,p as na,E as ia,a9 as ra,Y as ua,x as da}from"./index-f283a836.js";import{s as ce}from"./statuses-d74d988d.js";import{i as ca,w as ma,c as pa}from"./DragVerticalIcon-2abb2b05.js";import{u as va}from"./helpCenter-afdfc8c0.js";import{g as fa}from"./settings-9553d108.js";import{g as _a}from"./global-490945aa.js";import{_ as ga}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-ef6eaf2b.js";import{F as ya}from"./FileUploader-394f4eeb.js";import{u as ba}from"./pageMeta-88a8dc7c.js";import"./CallLogModal-7db0d549.js";import"./ArrowUpRightIcon-ef40b282.js";import"./LeadsIcon-4cc72eea.js";import"./DealsIcon-bd66a51b.js";import"./TaskModal-2e1eb09e.js";import"./TextEditor.vue_vue_type_script_setup_true_lang-db02e949.js";import"./FadedScrollableDiv-2d0feb53.js";import"./MultipleAvatar-db0bedac.js";import"./event-6e26dc08.js";import"./ComboboxViewport-4b6ecbaa.js";import"./IconPicker-19ca9a87.js";import"./EmailMultiSelect-64d043c7.js";const ha={class:"mb-6 flex items-center justify-between"},Ca={class:"text-2xl font-semibold leading-6 text-ink-gray-9"},ka={class:"flex items-center gap-1"},wa={class:"mb-4 flex items-center gap-2 text-ink-gray-5"},xa={class:"block text-base"},Ma={class:"ml-6 text-ink-gray-9"},Ia={class:"flex items-center justify-between text-base"},Va={key:1,class:"mt-2.5 text-base"},La={class:"mb-4 mt-6 flex items-center gap-2 text-ink-gray-5"},Ea={class:"block text-base"},Ra={class:"ml-6 text-ink-gray-9"},Da={class:"flex items-center justify-between text-base"},Ta={key:1,class:"mt-2.5 text-base"},$a={key:0,class:"h-px w-full border-t my-6"},Sa={class:"flex justify-end"},Aa={__name:"ConvertToDealModal",props:Ye({lead:{type:Object,required:!0}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(h){const U=h,E=Ze(h,"modelValue"),W=ue(),{statusOptions:Q,getDealStatus:X}=ce(),{isManager:G}=We(),{user:H}=ea(),{updateOnboardingStep:R}=va("frappecrm"),V=w(!1),C=w(!1),k=w(""),f=w(""),m=w(""),{triggerConvertToDeal:$}=Z("CRM Lead",U.lead.name),{document:_}=Z("CRM Deal");async function J(){if(m.value="",V.value&&!k.value){m.value=__("Please select an existing contact");return}if(C.value&&!f.value){m.value=__("Please select an existing organization");return}!V.value&&k.value&&(k.value=""),!C.value&&f.value&&(f.value=""),await($==null?void 0:$(U.lead,_.doc,()=>E.value=!1));let o=await ee("crm.fcrm.doctype.crm_lead.crm_lead.convert_to_deal",{lead:U.lead.name,deal:_.doc,existing_contact:k.value,existing_organization:f.value}).catch(i=>{var x;if(i.exc_type=="MandatoryError"){const l=i.messages.map(g=>{let y=g.split(": ");return y[y.length-1].trim()}).join(", ");l.toLowerCase().includes("required")?m.value=__(l):m.value=__("{0} is required",[l]);return}m.value=__("Error converting to deal: {0}",[(x=i.messages)==null?void 0:x[0]])});o&&(E.value=!1,V.value=!1,C.value=!1,k.value="",f.value="",m.value="",R("convert_lead_to_deal",!0,!1,()=>{localStorage.setItem("firstDeal"+H,o)}),ta("convert_lead_to_deal"),W.push({name:"Deal",params:{dealId:o}}))}const F=z(()=>{var i;let o=Q("deal");return(i=_.doc)!=null&&i.status||(_.doc.status=o[0].value),o}),O=de({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout",cache:["RequiredFields","CRM Deal"],params:{doctype:"CRM Deal",type:"Required Fields"},auto:!0,transform:o=>{let i=!1,x=o==null?void 0:o.forEach(l=>{var g;(g=l.sections)==null||g.forEach(y=>{var b;(b=y.columns)==null||b.forEach(S=>{var M;(M=S.fields)==null||M.forEach(D=>{i=!0,D.fieldname=="status"&&(D.fieldtype="Select",D.options=F.value,D.prefix=X(_.doc.status).color),D.fieldtype==="Table"&&(_.doc[D.fieldname]=[])})})})});return i?x:[]}});function P(){Te.value=!0,$e.value={doctype:"CRM Deal",onlyRequired:!0},E.value=!1}return(o,i)=>{const x=B("Button"),l=B("ErrorMessage");return u(),c(t(aa),{modelValue:E.value,"onUpdate:modelValue":i[5]||(i[5]=g=>E.value=g),options:{size:"xl"}},{"body-header":v(()=>[r("div",ha,[r("div",null,[r("h3",Ca,L(o.__("Convert to Deal")),1)]),r("div",ka,[t(G)()&&!t(ca)?(u(),c(x,{key:0,variant:"ghost",tooltip:o.__("Edit deal's mandatory fields layout"),icon:je,onClick:P},null,8,["tooltip"])):p("",!0),n(x,{icon:"x",variant:"ghost",onClick:i[0]||(i[0]=g=>E.value=!1)})])])]),"body-content":v(()=>{var g,y;return[r("div",wa,[n(Pe,{class:"h-4 w-4"}),r("label",xa,L(o.__("Organization")),1)]),r("div",Ma,[r("div",Ia,[r("div",null,L(o.__("Choose Existing")),1),n(t(se),{modelValue:C.value,"onUpdate:modelValue":i[1]||(i[1]=b=>C.value=b)},null,8,["modelValue"])]),C.value?(u(),c(le,{key:0,class:"form-control mt-2.5",size:"md",value:f.value,doctype:"CRM Organization",onChange:i[2]||(i[2]=b=>f.value=b)},null,8,["value"])):(u(),q("div",Va,L(o.__("New organization will be created based on the data in details section")),1))]),r("div",La,[n(Ne,{class:"h-4 w-4"}),r("label",Ea,L(o.__("Contact")),1)]),r("div",Ra,[r("div",Da,[r("div",null,L(o.__("Choose Existing")),1),n(t(se),{modelValue:V.value,"onUpdate:modelValue":i[3]||(i[3]=b=>V.value=b)},null,8,["modelValue"])]),V.value?(u(),c(le,{key:0,class:"form-control mt-2.5",size:"md",value:k.value,doctype:"Contact",onChange:i[4]||(i[4]=b=>k.value=b)},null,8,["value"])):(u(),q("div",Ta,L(o.__("New contact will be created based on the person's details")),1))]),(g=t(O).data)!=null&&g.length?(u(),q("div",$a)):p("",!0),(y=t(O).data)!=null&&y.length?(u(),c(Be,{key:1,tabs:t(O).data,data:t(_).doc,doctype:"CRM Deal"},null,8,["tabs","data"])):p("",!0),n(l,{class:"mt-4",message:m.value},null,8,["message"])]}),actions:v(()=>[r("div",Sa,[n(x,{label:o.__("Convert"),variant:"solid",onClick:J},null,8,["label"])])]),_:1},8,["modelValue"])}}},za={key:0,class:"flex h-full overflow-hidden"},qa={class:"flex items-center justify-start gap-5 border-b p-5"},Ua={class:"group relative size-12"},Fa={class:"z-1 absolute bottom-0.5 left-0 right-0.5 flex h-9 cursor-pointer items-center justify-center rounded-b-full bg-black bg-opacity-40 pt-3 opacity-0 duration-300 ease-in-out group-hover:opacity-100",style:{"-webkit-clip-path":"inset(12px 0 0 0)","clip-path":"inset(12px 0 0 0)"}},Oa={class:"flex flex-col gap-2.5 truncate"},Pa={class:"truncate text-2xl font-medium text-ink-gray-9"},Na={class:"flex gap-1.5"},ja={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},At={__name:"Lead",props:{leadId:{type:String,required:!0}},setup(h){const{brand:U}=fa(),{$dialog:E,$socket:W,makeCall:Q}=_a(),{statusOptions:X,getLeadStatus:G}=ce(),{doctypeMeta:H}=Qe("CRM Lead"),R=oa(),V=ue(),C=h,k=w(!1),f=w(null),m=w(""),$=w(""),_=w(!1),J=()=>{ee("crm_pipeline.api.create_pipeline_from_lead",{lead_name:C.leadId}).then(e=>{T.success(__("Lead converted to Pipeline successfully")),V.push({name:"Pipeline"})}).catch(e=>{T.error(e.message||__("Failed to convert Lead to Pipeline"))})},F=w(!1),{triggerOnChange:O,assignees:P,document:o,scripts:i,error:x}=Z("CRM Lead",C.leadId),l=z(()=>o.doc||{});ie(x,e=>{var a;e?(m.value=__(e.exc_type=="DoesNotExistError"?"Document not found":"Error occurred"),$.value=__(((a=e.messages)==null?void 0:a[0])||"An error occurred")):(m.value="",$.value="")}),ie(()=>o.doc,async e=>{var a;if((a=i.data)!=null&&a.length){let d=await Xe(i.data,{doc:e,$dialog:E,$socket:W,router:V,toast:T,updateField:j,createToast:T.create,deleteDoc:ae,call:ee});o._actions=d.actions||[],o._statuses=d.statuses||[]}},{once:!0});const g=z(()=>{let e=[{label:__("Leads"),route:{name:"Leads"}}];if(R.query.view||R.query.viewType){let a=Fe(R.query.view,R.query.viewType,"CRM Lead");a&&e.push({label:__(a.label),icon:a.icon,route:{name:"Leads",params:{viewType:R.query.viewType},query:{view:R.query.view}}})}return e.push({label:y.value,route:{name:"Lead",params:{leadId:C.leadId}}}),e}),y=z(()=>{var a,d;let e=((a=H["CRM Lead"])==null?void 0:a.title_field)||"name";return((d=l.value)==null?void 0:d[e])||C.leadId}),b=z(()=>{var a;let e=(a=o.statuses)!=null&&a.length?o.statuses:o._statuses||[];return X("lead",e,me)});ba(()=>({title:y.value,icon:U.favicon}));const S=z(()=>[{name:"Activity",label:__("Activity"),icon:be},{name:"Comments",label:__("Comments"),icon:Ie},{name:"Data",label:__("Data"),icon:Ve},{name:"Tasks",label:__("Tasks"),icon:Ee},{name:"Notes",label:__("Notes"),icon:Re},{name:"Attachments",label:__("Attachments"),icon:te},{name:"WhatsApp",label:__("WhatsApp"),icon:De,condition:()=>ma.value}].filter(a=>a.condition?a.condition():!0)),{tabIndex:M,changeTabTo:D}=he(S,"lastLeadTab"),K=de({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_sidepanel_sections",cache:["sidePanelSections","CRM Lead"],params:{doctype:"CRM Lead"},auto:!0});async function me(e){await O("status",e),o.save.submit()}function j(e,a){a=Array.isArray(e)?"":a;let d=Array.isArray(e)?{}:l.value[e];Array.isArray(e)?e.forEach(N=>l.value[N]=a):l.value[e]=a,o.save.submit(null,{onSuccess:()=>k.value=!0,onError:N=>{var s;Array.isArray(e)?e.forEach(I=>l.value[I]=d[I]):l.value[e]=d,T.error(((s=N.messages)==null?void 0:s[0])||__("Error updating field"))}})}function ae(){_.value=!0}function pe(){let e=S.value[M.value];["Emails","Comments","Activities"].includes(e.name)||f.value.changeTabTo("emails"),da(()=>f.value.emailBox.show=!0)}function ve(e){o.save.submit(null,{onSuccess:()=>Y(e)})}function Y(e){e!=null&&e.hasOwnProperty("lead_owner")&&P.reload()}return(e,a)=>{const d=B("Button"),N=B("ErrorMessage");return u(),q(sa,null,[n(Ue,null,la({"left-header":v(()=>[n(t(ga),{items:g.value},{prefix:v(({item:s})=>[s.icon?(u(),c(ge,{key:0,icon:s.icon,class:"mr-2 h-4"},null,8,["icon"])):p("",!0)]),_:1},8,["items"])]),_:2},[m.value?void 0:{name:"right-header",fn:v(()=>{var s,I;return[(s=t(o)._actions)!=null&&s.length?(u(),c(oe,{key:0,actions:t(o)._actions},null,8,["actions"])):p("",!0),(I=t(o).actions)!=null&&I.length?(u(),c(oe,{key:1,actions:t(o).actions},null,8,["actions"])):p("",!0),n(ke,{modelValue:t(P).data,"onUpdate:modelValue":a[0]||(a[0]=A=>t(P).data=A),doctype:"CRM Lead",docname:h.leadId},null,8,["modelValue","docname"]),l.value&&t(o).statuses?(u(),c(t(ne),{key:2,options:b.value,placement:"right"},{default:v(({open:A})=>[l.value.status?(u(),c(d,{key:0,label:l.value.status,iconRight:A?"chevron-up":"chevron-down"},{prefix:v(()=>[n(Se,{class:na(t(G)(l.value.status).color)},null,8,["class"])]),_:1},8,["label","iconRight"])):p("",!0)]),_:1},8,["options"])):p("",!0),n(d,{label:e.__("Convert to Pipeline"),variant:"solid",onClick:J},null,8,["label"])]}),key:"0"}]),1024),l.value.name?(u(),q("div",za,[n(t(Ae),{as:"div",modelValue:t(M),"onUpdate:modelValue":a[3]||(a[3]=s=>re(M)?M.value=s:null),tabs:S.value},{"tab-panel":v(()=>[n(we,{ref_key:"activities",ref:f,doctype:"CRM Lead",docname:h.leadId,tabs:S.value,reload:k.value,"onUpdate:reload":a[1]||(a[1]=s=>k.value=s),tabIndex:t(M),"onUpdate:tabIndex":a[2]||(a[2]=s=>re(M)?M.value=s:null),onBeforeSave:ve,onAfterSave:Y},null,8,["docname","tabs","reload","tabIndex"])]),_:1},8,["modelValue","tabs"]),n(ye,{class:"flex flex-col justify-between border-l",side:"right"},{default:v(()=>[r("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium text-ink-gray-9",onClick:a[4]||(a[4]=s=>t(Ge)(h.leadId))},L(e.__(h.leadId)),1),n(t(ya),{onSuccess:a[6]||(a[6]=s=>j("image",s.file_url)),validateFile:t(He)},{default:v(({openFileSelector:s,error:I})=>[r("div",qa,[r("div",Ua,[n(t(Je),{size:"3xl",class:"size-12",label:y.value,image:l.value.image},null,8,["label","image"]),(u(),c(ra(l.value.image?t(ne):"div"),ia(l.value.image?{options:[{icon:"upload",label:l.value.image?e.__("Change image"):e.__("Upload image"),onClick:s},{icon:"trash-2",label:e.__("Remove image"),onClick:()=>j("image","")}]}:{onClick:s},{class:"!absolute bottom-0 left-0 right-0"}),{default:v(()=>[r("div",Fa,[n(ze,{class:"size-4 cursor-pointer text-white"})])]),_:1},16))]),r("div",Oa,[n(t(ua),{text:l.value.lead_name||e.__("Set first name")},{default:v(()=>[r("div",Pa,L(y.value),1)]),_:1},8,["text"]),r("div",Na,[t(pa)?(u(),c(d,{key:0,tooltip:e.__("Make a call"),icon:Le,onClick:()=>l.value.mobile_no?t(Q)(l.value.mobile_no):t(T).error(e.__("No phone number set"))},null,8,["tooltip","onClick"])):p("",!0),n(d,{tooltip:e.__("Send an email"),icon:Me,onClick:A=>l.value.email?pe():t(T).error(e.__("No email set"))},null,8,["tooltip","onClick"]),n(d,{tooltip:e.__("Go to website"),icon:qe,onClick:A=>l.value.website?t(Ke)(l.value.website):t(T).error(e.__("No website set"))},null,8,["tooltip","onClick"]),n(d,{tooltip:e.__("Attach a file"),icon:te,onClick:a[5]||(a[5]=A=>F.value=!0)},null,8,["tooltip"]),n(d,{tooltip:e.__("Delete"),variant:"subtle",theme:"red",icon:"trash-2",onClick:ae},null,8,["tooltip"])]),n(N,{message:e.__(I)},null,8,["message"])])])]),_:1},8,["validateFile"]),l.value.sla_status?(u(),c(xe,{key:0,modelValue:l.value,"onUpdate:modelValue":a[7]||(a[7]=s=>l.value=s),onUpdateField:j},null,8,["modelValue"])):p("",!0),t(K).data?(u(),q("div",ja,[n(Oe,{sections:t(K).data,doctype:"CRM Lead",docname:h.leadId,onReload:t(K).reload,onAfterFieldChange:Y},null,8,["sections","docname","onReload"])])):p("",!0)]),_:1})])):m.value?(u(),c(_e,{key:1,errorTitle:m.value,errorMessage:$.value},null,8,["errorTitle","errorMessage"])):p("",!0),e.showConvertToDealModal?(u(),c(Aa,{key:2,modelValue:e.showConvertToDealModal,"onUpdate:modelValue":a[8]||(a[8]=s=>e.showConvertToDealModal=s),lead:l.value},null,8,["modelValue","lead"])):p("",!0),n(Ce,{modelValue:F.value,"onUpdate:modelValue":a[9]||(a[9]=s=>F.value=s),doctype:"CRM Lead",docname:h.leadId,onAfter:a[10]||(a[10]=()=>{var s,I;(I=(s=f.value)==null?void 0:s.all_activities)==null||I.reload(),t(D)("attachments")})},null,8,["modelValue","docname"]),_.value?(u(),c(fe,{key:3,modelValue:_.value,"onUpdate:modelValue":a[11]||(a[11]=s=>_.value=s),doctype:"CRM Lead",docname:h.leadId,name:"Leads"},null,8,["modelValue","docname"])):p("",!0)],64)}}};export{At as default};
//# sourceMappingURL=Lead-7b5d7090.js.map
